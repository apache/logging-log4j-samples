#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to you under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: android-reusable-test

on:
  workflow_call:
    inputs:
      log4j-version:
        description: 'Log4j version'
        required: true
        type: string

permissions: read-all

jobs:

  build:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@d632683dd7b4114ad314bca15554477dd762a938   # 4.2.0

      - name: Setup Java
        uses: actions/setup-java@b36c23c0d998641eff861008f374ee103c25ac73   # 4.4.0
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Setup Android SDK
        shell: bash
        env:
          ANDROID_SDK_VERSION: 10406996
          ANDROID_SDK_CHECKSUM: 8919e8752979db73d8321e9babe2caedcc393750817c1a5f56c128ec442fb540
        run: |
          # Create home directory
          export ANDROID_HOME=$HOME/.android/sdk
          mkdir -p $ANDROID_HOME
          
          # Download and verify the `cmdline-tools`
          curl -o $ANDROID_HOME/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_VERSION}_latest.zip
          echo "$ANDROID_SDK_CHECKSUM $ANDROID_HOME/cmdline-tools.zip" | sha256sum -c
          unzip -d $ANDROID_HOME/cmdline-tools{,.zip}
          mv $ANDROID_HOME/cmdline-tools/{cmdline-tools,latest}
          
          # Accept licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          
          # Installing the remaining tools
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager tools platform-tools
          
          # Exporting ANDROID_HOME and adding sdkmanager to the PATH
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo $ANDROID_HOME/cmdline-tools/latest/bin >> $GITHUB_PATH

      - name: Build
        id: build
        shell: bash
        env:
          LOG4J_VERSION: ${{ inputs.log4j-version }}
        run: |
          log4j-samples-android/gradlew -p log4j-samples-gradlew \
          --console plain \
          -Plog4jVersion=$LOG4J_VERSION \
          build connectedCheck
